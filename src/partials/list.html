<div class="masthead row" ng-show='!isRouteLoading'>
  <div class="col-xs-12 col-sm-8 col-sm-offset-4 col-md-9 col-md-offset-3 pull-right">
    <h2 class="heading-contact-list">{{locationText()}} <small>(<span translate>Contacts</span> {{queryCount}})</small></h2>
  </div>
</div>

<div class="main row page-list" ng-show='!isRouteLoading' ng-class="{'show-options': sidebarOptions}">
  <div class="active-contacts col-xs-12 col-sm-8 col-md-9 pull-right">
    <browser-alert></browser-alert>

    <form class="search-form">
      <div class="form-group">
        <label class="control-label element-invisible" for="text" translate>Search</label>
        <div class="input-groupx">
          <input class="form-control contact-search" type="search" name="text"
                 placeholder="{{'Search by name, title, or organization'|translate}}" ng-model="query.text"/>
          <input class="btn btn-lg contact-search-submit" type="submit" ng-click="submitSearch()" value="{{'Search'|translate}}"/>
        </div>
      </div>
    </form>

    <ul class="list-group" cg-busy="contactsPromise">
      <li class="profile-item list-group-item" ng-repeat="contact in contacts | orderBy: ['nameGiven', 'nameFamily']" ng-init="contactInit()" ng-class="{'has-quick-link': contact.ql.userCanEditProfile}">
        <div class="row">
          <div class="contact-item contact-item--name col-xs-12 col-md-3" >
            <a href="#/contact/{{contact._id}}" title="{{contact.nameGiven}} {{contact.nameFamily}}">{{contact.nameGiven}} {{contact.nameFamily}}</a>
            <div class="contact-item__markers" ng-if="contact.keyContact || contact._profile.verified">
              <div class="contact-item__key-contact" title="Key Contact" ng-if="contact.keyContact"><i class="fa fa-asterisk"></i></span></div>
              <span class="contact-item__verified" title="Verified" ng-if="contact._profile.verified"><i class="fa fa-check-circle"></i></span>
            </div>
          </div>
          <div class="contact-item contact-item--jobtitle col-xs-7" ng-class="(contact.bundle.length) ? 'col-md-3' : 'col-md-7'"><span title="{{contact.jobtitle}}">{{contact.jobtitle}}</span></div>
          <div class="contact-item contact-item--bundle col-md-4" ng-hide="!contact.bundle.length"><span title="{{contact.bundle.join(', ')}}">{{contact.bundle.join(', ')}}</span></div>
          <div class="contact-item contact-item--organization col-xs-5 col-md-2"><span title="{{parseAcronym(contact.organization[0].name)}}">{{parseAcronym(contact.organization[0].name)}}</span></div>
        </div>
        <div class="quick-link" ng-if="showQuickLinks(contact)">
          <div class="dropdown" ng-class="{'ql-open': qlOpen === $index}">
            <button class="dropdown-toggle" data-toggle="dropdown" type="button" ng-click="qlClick()"><span class="quick-link-dots"></span></button>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
              <li ng-if="contact.ql.userCanEditProfile">
                <a role="menuitem" tabindex="-1" href="#/profile/{{contact._id}}" translate>Edit</a>
              </li>
              <li ng-if="contact.ql.userCanCheckIn">
                <a role="menuitem" tabindex="-1" href="#/checkin{{contact.ql.isOwn ? '' : '/' + contact._profile._id}}" translate>Check-in</a>
              </li>
              <li ng-if="contact.ql.userCanCheckOut" ng-class="{'disabled':contact.ql.checkOutState === 'inProgress'}">
                <button role="menuitem" tabindex="-1" class="btn btn-link" ng-class="{'btn-warning': contact.ql.checkOutState === 'confirm'}" ng-click="checkOut(contact)" ng-bind="checkOutText(contact)"></button>
              </li>
              <li ng-if="contact.ql.userCanSendClaimEmail" ng-class="{'disabled':contact.ql.orphanState === 'complete' || contact.ql.orphanState === 'inProgress'}">
                <button role="menuitem" tabindex="-1" class="btn btn-link" ng-class="{'btn-warning': contact.ql.orphanState === 'confirm'}" ng-click="sendClaimEmail(contact)" ng-bind="orphanText(contact)"></button>
              </li>
              <li ng-if="contact.ql.userCanDeleteAccount" ng-class="{'disabled':contact.ql.deleteState === 'inProgress'}">
                <button role="menuitem" tabindex="-1" class="btn btn-link" ng-class="{'btn-warning': contact.ql.deleteState === 'confirm'}" ng-click="deleteAccount(contact)" ng-bind="deleteText(contact)"></button>
              </li>
              <li ng-if="contact.ql.userCanEditKeyContact || contact.ql.userCanEditVerified" class="divider"></li>
              <li ng-if="contact.ql.userCanEditKeyContact" ng-class="{'disabled': contact.ql.keyContactState === 'inProgress'}">
                <button role="menuitem" tabindex="-1" class="btn btn-link" ng-class="{'btn-warning': contact.ql.keyContactState === 'confirm'}" ng-click="updateProfile(contact,'keyContact')" ng-bind="keyContactText(contact)"></button>
              </li>
              <li ng-if="contact.ql.userCanEditVerified" ng-class="{'disabled': contact.ql.verifiedState === 'inProgress'}">
                <button role="menuitem" tabindex="-1" class="btn btn-link" ng-class="{'btn-warning': contact.ql.verifiedState === 'confirm'}" ng-click="updateProfile(contact,'verified')" ng-bind="verifiedText(contact)"></button>
              </li>
            </ul>
          </div>
        </div>
      </li>
    </ul>

    <div class="panel panel-danger" ng-if="contacts.length == 0 && contactsCreated">
      <div class="panel-heading"><em translate>No contacts found</em></div>
    </div>

    <div class="contact-loader" ng-class="{'list-complete': listComplete || !contacts.length}" in-view="loadMoreContacts($inview, $inviewpart)" in-view-options="{debounce: 1000}" cg-busy="{promise:contactsPromise, message:'', backdrop:false, templateUrl:spinTpl, minDuration:1400, wrapperClass:'list-spinner'}"></div>

    <div class="contact-count" ng-show="contactsCount">{{contactsCount}} / {{queryCount}}</div>
  </div>

  <div class="sidebar-left">
    <div ng-show="!isRouteLoading">
      <div class="visible-xs">
        <div class="bottom-fixed-btn" role="presentation">
          <a href ng-click="sidebarOptions = !sidebarOptions"><div class="bottom-fixed-btn__arrow"></div><span translate>Contact List Filters</span></a>
        </div>
      </div>
    </div>

    <div class="actions-wrapper col-xs-12 col-sm-4 col-md-3">
      <form class="filter-form actions">
        <div class="form-group form-group-reset">
          <h2>
            <small class="control-label " translate>Filter Results</small>
          </h2>
          <input class="btn btn-warning btn-lg btn-reset" type="button" ng-if="showResetBtn" ng-click="resetSearch()" value="{{'Clear All'|translate}}"/>
        </div>
        <div class="form-group" ng-show="bundles.length">
          <label class="control-label element-invisible" for="bundle" translate>Group</label>
          <ui-select
            ng-model="query.bundle"
            theme="bootstrap"
            class="form-control"
            name="bundle"
            search-enabled="false"
            on-select="submitSearch()">
              <ui-select-match allow-clear placeholder="{{'Group'|translate}}">{{$select.selected.value.name}}</ui-select-match>
              <ui-select-choices repeat="bundle.value.name as bundle in bundles | orderBy:'value.name'">
                <div ng-bind-html="bundle.value.name"></div>
              </ui-select-choices>
          </ui-select>
        </div>

        <div class="form-group" ng-show="protectedBundles.length">
          <label class="control-label element-invisible" for="protectedBundle" translate>Protected Group</label>
          <ui-select
            ng-model="query.protectedBundles"
            theme="bootstrap"
            class="form-control"
            name="protectedBundle"
            search-enabled="false"
            on-select="submitSearch()">
              <ui-select-match allow-clear placeholder="{{'Protected Group'|translate}}">{{$select.selected.value.name}}</ui-select-match>
              <ui-select-choices repeat="protectedBundle.value.name as protectedBundle in protectedBundles | orderBy:'value.name'">
                <div ng-bind-html="protectedBundle.value.name"></div>
              </ui-select-choices>
          </ui-select>
        </div>

        <div class="form-group">
          <label class="control-label element-invisible" for="organization" translate>Organization</label>
          <ui-select
            class="form-control {{$select.searching ? 'searching' : ''}}"
            name="organization"
            ng-model="query['organization.name']"
            theme="bootstrap"
            reset-search-input="true"
            on-select="submitSearch()">
              <ui-select-match allow-clear placeholder="{{'Organization'|translate}}">{{$select.selected.name}}</ui-select-match>
              <ui-select-choices repeat="org.name as org in organizations | orderBy:'name'" refresh="refreshOrganization($select, 2)" ui-disable-choice="org.disable">
                <div ng-bind-html="org.alt || (org.name | highlight: $select.search) "></div>
              </ui-select-choices>
          </ui-select>
        </div>

        <div class="form-group">
          <label class="control-label element-invisible" for="protectedRole" translate>Role</label>
          <ui-select
            ng-model="query.protectedRoles"
            theme="bootstrap"
            class="form-control"
            name="bootstrap"
            search-enabled="false"
            on-select="submitSearch()">
              <ui-select-match allow-clear placeholder="{{'Role'|translate}}">{{$select.selected.name}}</ui-select-match>
              <ui-select-choices repeat="protectedRole.id as protectedRole in protectedRoles | orderBy:'name'">
                <div ng-bind-html="protectedRole.name"></div>
              </ui-select-choices>
          </ui-select>
        </div>

        <div class="location-filters">
          <div class="form-group">
            <label class="control-label element-invisible" for="country" translate>Country</label>
            <ui-select
              ng-model="query['address.country']"
              theme="bootstrap"
              class="form-control"
              name="country"
              reset-search-input="true"
              on-select="submitSearch()">
                <ui-select-match allow-clear placeholder="{{'Country'|translate}}">{{$select.selected.name}}</ui-select-match>
                <ui-select-choices ng-class="{'not-empty': countries.length}" repeat="country.name as country in countries | orderBy:'name' | filter: $select.search">
                  <div ng-bind-html="country.name | highlight: $select.search"></div>
                </ui-select-choices>
            </ui-select>
          </div>

          <div class="form-group" ng-show="locationId !== 'global' && regions.length">
            <label class="control-label element-invisible" for="region" translate>Region</label>
            <ui-select
              ng-model="query['address.administrative_area']"
              theme="bootstrap"
              class="form-control"
              name="region"
              search-enabled="false"
              on-select="submitSearch()">
                <ui-select-match allow-clear placeholder="{{'Region'|translate}}">{{$select.selected.name}}</ui-select-match>
                <ui-select-choices repeat="region.name as region in regions | orderBy:'name'">
                  <div ng-bind-html="region.name"></div>
                </ui-select-choices>
            </ui-select>
          </div>

        </div>

        <div class="form-group" ng-show="disasterOptions.length">
          <label class="control-label element-invisible" for="disaster" translate>Disasters</label>
          <ui-select
            ng-model="query['disasters.remote_id']"
            theme="bootstrap"
            class="form-control"
            name="disaster"
            search-enabled="false"
            on-select="submitSearch()">
              <ui-select-match allow-clear placeholder="{{'Disaster'|translate}}">{{$select.selected.value.name}}</ui-select-match>
              <ui-select-choices repeat="disaster.value.remote_id as disaster in disasterOptions | orderBy:'value.name'">
                <div ng-bind-html="disaster.value.name"></div>
              </ui-select-choices>
          </ui-select>
        </div>

        <div class="divider"></div>

        <div class="form-group">
          <label class="control-label" for="verified"><i class="fa fa-check-circle"></i> <span translate>Verified User</span> <input type="checkbox" name="verified" ng-model="query.verified" /></label>
        </div>

        <div class="form-group" ng-if="query.locationId">
          <label class="control-label" for="keyContact"><span class="contact-item__key-contact key-contact-filter-use"><i class="fa fa-asterisk"></i></span><span translate>Key Contact</span> <input type="checkbox" name="keyContact" ng-model="query.keyContact" /></label>
        </div>

        <div class="form-group" ng-if="userCanUseAdminFilters">
          <div class="divider"></div>

          <label class="control-label" for="orphan"><span translate>Orphan User</span> <input type="checkbox" name="orphan" ng-model="query.orphan" /></label>
        </div>

        <div class="form-group" ng-if="userCanUseAdminFilters">
          <label class="control-label" for="ghost"><span translate>Ghost User</span> <input type="checkbox" name="ghost" ng-model="query.ghost" /></label>
        </div>

        <div class="form-group" ng-if="userCanUseAdminFilters">
          <label class="control-label element-invisible" for="role" translate>Admin Role</label>
          <ui-select
            ng-model="query.role"
            theme="bootstrap"
            class="form-control"
            name="bootstrap"
            search-enabled="false"
            on-select="submitSearch()">
              <ui-select-match allow-clear placeholder="{{'Admin Role'|translate}}">{{$select.selected.name}}</ui-select-match>
              <ui-select-choices repeat="role.id as role in adminRoleOptions | orderBy:'name' | filter: $select.search">
                <div ng-bind-html="role.name | highlight: $select.search"></div>
              </ui-select-choices>
          </ui-select>
        </div>

        <div ng-if="!query.locationId">

          <div class="divider"></div>

          <div class="form-group">
            <label class="control-label" for="globalContacts"><span translate>Global Profiles</span> <input type="checkbox" name="globalContacts" ng-model="query.globalContacts" /></label>
          </div>

          <div class="form-group">
            <label class="control-label" for="localContacts"><span translate>Local Profiles</span> <input type="checkbox" name="localContacts" ng-model="query.localContacts" /></label>
          </div>

        </div>

        <div class="divider"></div>

        <div class="form-group">
          <input class="btn btn-primary btn-lg btn-block" type="submit" ng-click="submitSearch()" value="{{'Search'|translate}}"/>
        </div>
        <div class="divider"></div>
        <div class="form-group">
          <input class="btn btn-warning btn-lg btn-block" type="button" ng-click="exportEmail()" value="{{'Copy Email Addresses'|translate}}"/>

          <input class="btn btn-warning btn-lg btn-block" type="button" ng-click="openPDF()" value="{{'View PDF'|translate}}"/>

          <input class="btn btn-warning btn-lg btn-block" type="button" ng-click="exportSearch()" value="{{'Export Results'|translate}}"/>

        </div>
      </form>
    </div>
  </div>
</div>
